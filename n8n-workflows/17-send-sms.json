{
  "name": "Rodopi Dent - Send SMS",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "send-sms",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 0],
      "webhookId": "send-sms"
    },
    {
      "parameters": {
        "jsCode": "// Parse input\nconst body = $input.first().json.body;\n\nif (!body.phone || !body.message) {\n  throw new Error('Phone and message are required');\n}\n\n// Normalize Bulgarian phone number\nlet phone = body.phone.replace(/\\s+/g, '').replace(/[^0-9+]/g, '');\n\n// Convert to international format\nif (phone.startsWith('0')) {\n  phone = '+359' + phone.substring(1);\n} else if (!phone.startsWith('+')) {\n  phone = '+359' + phone;\n}\n\n// SMS Templates\nconst templates = {\n  'booking_received': `–†–æ–¥–æ–ø–∏ –î–µ–Ω—Ç: –ó–∞—è–≤–∫–∞—Ç–∞ –≤–∏ –∑–∞ —á–∞—Å –Ω–∞ {date} –≤ {time} –µ –ø–æ–ª—É—á–µ–Ω–∞ –∏ —á–∞–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ. –©–µ –ø–æ–ª—É—á–∏—Ç–µ SMS –ø—Ä–∏ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ.`,\n  'booking_confirmed': `–†–æ–¥–æ–ø–∏ –î–µ–Ω—Ç: –ß–∞—Å—ä—Ç –≤–∏ –µ –ü–û–¢–í–™–†–î–ï–ù! \\nüìÖ {date}\\nüïê {time}\\n‚è±Ô∏è {duration} –º–∏–Ω.\\n–û—á–∞–∫–≤–∞–º–µ –≤–∏!`,\n  'booking_rejected': `–†–æ–¥–æ–ø–∏ –î–µ–Ω—Ç: –ó–∞ —Å—ä–∂–∞–ª–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ–º –¥–∞ –ø–æ—Ç–≤—ä—Ä–¥–∏–º —á–∞—Å–∞ –≤–∏ –∑–∞ {date} –≤ {time}. –©–µ —Å–µ —Å–≤—ä—Ä–∂–µ–º —Å –≤–∞—Å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∑–∞ –∞–ª—Ç–µ—Ä–Ω–∞—Ç–∏–≤–µ–Ω —á–∞—Å.`,\n  'booking_conflict': `–†–æ–¥–æ–ø–∏ –î–µ–Ω—Ç: –ß–∞—Å—ä—Ç –≤–∏ –∑–∞ {date} –≤ {time} –µ –æ—Ç–º–µ–Ω–µ–Ω –ø–æ—Ä–∞–¥–∏ –∑–∞—Å—Ç—ä–ø–≤–∞–Ω–µ. –©–µ —Å–µ —Å–≤—ä—Ä–∂–µ–º —Å –≤–∞—Å –∑–∞ –Ω–æ–≤ —á–∞—Å.`,\n  'booking_expired': `–†–æ–¥–æ–ø–∏ –î–µ–Ω—Ç: –ó–∞—è–≤–∫–∞—Ç–∞ –≤–∏ –∑–∞ {date} –≤ {time} –∏–∑—Ç–µ—á–µ –±–µ–∑ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ. –ú–æ–ª—è —Å–≤—ä—Ä–∂–µ—Ç–µ —Å–µ —Å –Ω–∞—Å –∑–∞ –Ω–æ–≤ —á–∞—Å.`,\n  'reminder': `–†–æ–¥–æ–ø–∏ –î–µ–Ω—Ç: –ù–∞–ø–æ–º–Ω—è–Ω–µ - –∏–º–∞—Ç–µ —á–∞—Å —É—Ç—Ä–µ ({date}) –≤ {time}. –û—á–∞–∫–≤–∞–º–µ –≤–∏!`\n};\n\n// Get template or use custom message\nlet message = body.message;\nif (body.template && templates[body.template]) {\n  message = templates[body.template];\n  \n  // Replace placeholders\n  if (body.date) message = message.replace(/{date}/g, body.date);\n  if (body.time) message = message.replace(/{time}/g, body.time);\n  if (body.duration) message = message.replace(/{duration}/g, body.duration);\n  if (body.patientName) message = message.replace(/{name}/g, body.patientName);\n}\n\nreturn [{\n  json: {\n    phone: phone,\n    message: message,\n    template: body.template || 'custom',\n    originalData: body\n  }\n}];"
      },
      "id": "prepare",
      "name": "Prepare SMS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SMS_PROVIDER_URL || 'https://api.sms.to/sms/send' }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.message }}"
            },
            {
              "name": "sender_id",
              "value": "RodopiDent"
            }
          ]
        },
        "options": {}
      },
      "id": "send-sms",
      "name": "Send SMS via Provider",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 0],
      "credentials": {
        "httpHeaderAuth": {
          "id": "",
          "name": "SMS Provider API Key"
        }
      },
      "notes": "Configure SMS provider credentials here. Supports: SMS.to, Twilio, BulSMS, etc."
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'SMS –∏–∑–ø—Ä–∞—Ç–µ–Ω —É—Å–ø–µ—à–Ω–æ', phone: $json.phone }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "respond-success",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [660, 0]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: 'SMS –Ω–µ –º–æ–∂–∞ –¥–∞ –±—ä–¥–µ –∏–∑–ø—Ä–∞—Ç–µ–Ω', details: $json }) }}",
        "options": {
          "responseCode": "500",
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "respond-error",
      "name": "Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [660, 200]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Prepare SMS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare SMS": {
      "main": [
        [
          {
            "node": "Send SMS via Provider",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send SMS via Provider": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "Rodopi Dent"
    }
  ]
}
