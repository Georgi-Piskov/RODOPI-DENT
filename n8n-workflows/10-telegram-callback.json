{
  "name": "Rodopi Dent - Telegram Callback Handler (Calendar)",
  "nodes": [
    {
      "parameters": {
        "updates": ["callback_query"],
        "additionalFields": {}
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [0, 0],
      "credentials": {
        "telegramApi": {
          "id": "",
          "name": "Telegram API"
        }
      },
      "webhookId": "telegram-callback"
    },
    {
      "parameters": {
        "jsCode": "const callback = $input.first().json;\n\n// Check if this is a callback_query (button press)\nif (!callback.callback_query) {\n  return [{ json: { error: 'Not a callback query', valid: false, skip: true } }];\n}\n\nconst callbackData = callback.callback_query.data;\nconst messageId = callback.callback_query.message.message_id;\nconst chatId = callback.callback_query.message.chat.id;\n\nlet action, duration, eventId;\n\nif (callbackData.startsWith('confirm_')) {\n  const parts = callbackData.split('_');\n  action = 'confirm';\n  duration = parseInt(parts[1]);\n  // Event ID is everything after confirm_XX_\n  eventId = parts.slice(2).join('_');\n} else if (callbackData.startsWith('cancel_')) {\n  action = 'cancel';\n  duration = 0;\n  eventId = callbackData.replace('cancel_', '');\n} else {\n  return [{ json: { error: 'Unknown action', valid: false } }];\n}\n\nreturn [{\n  json: {\n    action: action,\n    duration: duration,\n    eventId: eventId,\n    messageId: messageId,\n    chatId: chatId,\n    valid: true\n  }\n}];"
      },
      "id": "parse-callback",
      "name": "Parse Callback",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 0]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.valid }}",
              "value2": true
            }
          ]
        }
      },
      "id": "is-valid",
      "name": "Is Valid?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [440, 0]
    },
    {
      "parameters": {
        "operation": "get",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "rodopi.dent@gmail.com"
        },
        "eventId": "={{ $('Parse Callback').first().json.eventId }}"
      },
      "id": "get-event",
      "name": "Get Calendar Event",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.2,
      "position": [660, 100],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "",
          "name": "Google Calendar"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const parsed = $('Parse Callback').first().json;\nconst event = $input.first().json;\n\nif (!event || !event.id) {\n  return [{ json: { error: '–°—ä–±–∏—Ç–∏–µ—Ç–æ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ', action: 'error', chatId: parsed.chatId } }];\n}\n\n// Check if already confirmed (doesn't have ‚è≥ in title)\nconst title = event.summary || '';\nif (!title.includes('‚è≥')) {\n  return [{ json: { error: '–ó–∞–ø–∏—Å—ä—Ç –≤–µ—á–µ –µ –æ–±—Ä–∞–±–æ—Ç–µ–Ω', action: 'already_processed', chatId: parsed.chatId } }];\n}\n\n// Extract patient name (remove ‚è≥ prefix)\nconst patientName = title.replace('‚è≥ ', '').trim();\n\n// Get start time from event\nconst startDateTime = event.start?.dateTime || event.start?.date;\nconst date = startDateTime.slice(0, 10);\nconst startTime = startDateTime.slice(11, 16);\n\n// Extract phone from description\nconst description = event.description || '';\nconst phoneMatch = description.match(/üìû –¢–µ–ª: ([^\\n]+)/);\nconst phone = phoneMatch ? phoneMatch[1].trim() : '';\n\n// Extract reason from description\nconst reasonMatch = description.match(/üìã –ü—Ä–∏—á–∏–Ω–∞: ([^\\n]+)/);\nconst reason = reasonMatch ? reasonMatch[1].trim() : '';\n\nif (parsed.action === 'cancel') {\n  return [{\n    json: {\n      eventId: event.id,\n      patientName: patientName,\n      patientPhone: phone,\n      date: date,\n      startTime: startTime,\n      reason: reason,\n      action: 'cancel',\n      messageId: parsed.messageId,\n      chatId: parsed.chatId,\n      valid: true\n    }\n  }];\n}\n\n// For confirm action, calculate new end time based on duration\nconst newDuration = parsed.duration;\nconst [hours, minutes] = startTime.split(':').map(Number);\nconst startMinutes = hours * 60 + minutes;\nconst endMinutes = startMinutes + newDuration;\nconst endHours = Math.floor(endMinutes / 60);\nconst endMins = endMinutes % 60;\nconst newEndTime = `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;\n\n// Build new description (update status)\nlet newDescription = description\n  .replace(/‚è≥ –°—Ç–∞—Ç—É—Å: –ß–ê–ö–ê–© \\(pending\\)/, '‚úÖ –°—Ç–∞—Ç—É—Å: –ü–û–¢–í–™–†–î–ï–ù')\n  .replace(/‚è≥ –°—Ç–∞—Ç—É—Å: pending/, '‚úÖ –°—Ç–∞—Ç—É—Å: –ü–û–¢–í–™–†–î–ï–ù');\n\nif (!newDescription.includes('‚úÖ –°—Ç–∞—Ç—É—Å:')) {\n  newDescription += '\\n‚úÖ –°—Ç–∞—Ç—É—Å: –ü–û–¢–í–™–†–î–ï–ù';\n}\nnewDescription += `\\n‚è±Ô∏è –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç: ${newDuration} –º–∏–Ω.`;\n\nreturn [{\n  json: {\n    eventId: event.id,\n    patientName: patientName,\n    patientPhone: phone,\n    date: date,\n    startTime: startTime,\n    newEndTime: newEndTime,\n    newEndDateTime: `${date}T${newEndTime}:00`,\n    duration: newDuration,\n    reason: reason,\n    newSummary: `‚úÖ ${patientName}`,\n    newDescription: newDescription,\n    action: 'confirm',\n    messageId: parsed.messageId,\n    chatId: parsed.chatId,\n    valid: true\n  }\n}];"
      },
      "id": "process-action",
      "name": "Process Action",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 100]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "confirm-check",
              "leftValue": "={{ $json.action }}",
              "rightValue": "confirm",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "is-confirm",
      "name": "Is Confirm?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 0]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "cancel-check",
              "leftValue": "={{ $json.action }}",
              "rightValue": "cancel",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "is-cancel",
      "name": "Is Cancel?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 200]
    },
    {
      "parameters": {
        "operation": "update",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "rodopi.dent@gmail.com"
        },
        "eventId": "={{ $json.eventId }}",
        "updateFields": {
          "end": "={{ $json.newEndDateTime }}",
          "summary": "={{ $json.newSummary }}",
          "description": "={{ $json.newDescription }}",
          "colorId": "10"
        }
      },
      "id": "update-confirmed",
      "name": "Update Event Confirmed",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.2,
      "position": [1320, -100],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "",
          "name": "Google Calendar"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "rodopi.dent@gmail.com"
        },
        "eventId": "={{ $json.eventId }}"
      },
      "id": "delete-cancelled",
      "name": "Delete Event Cancelled",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.2,
      "position": [1320, 200],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "",
          "name": "Google Calendar"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Process Action').item.json.chatId }}",
        "text": "=‚úÖ *–ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ!*\n\nüë§ {{ $('Process Action').item.json.patientName }}\nüìÖ {{ $('Process Action').item.json.date }}\nüïê {{ $('Process Action').item.json.startTime }} - {{ $('Process Action').item.json.newEndTime }}\n‚è±Ô∏è –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç: {{ $('Process Action').item.json.duration }} –º–∏–Ω.",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "telegram-confirm-reply",
      "name": "Reply Confirmed",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1540, -100],
      "credentials": {
        "telegramApi": {
          "id": "",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.simeontsvetanovn8nworkflows.site/webhook/send-sms",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('Process Action').item.json.patientPhone }}\",\n  \"template\": \"booking_confirmed\",\n  \"date\": \"{{ $('Process Action').item.json.date }}\",\n  \"time\": \"{{ $('Process Action').item.json.startTime }}\",\n  \"duration\": \"{{ $('Process Action').item.json.duration }}\",\n  \"patientName\": \"{{ $('Process Action').item.json.patientName }}\"\n}",
        "options": {}
      },
      "id": "sms-confirmed",
      "name": "SMS Confirmed",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, -200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Process Action').item.json.chatId }}",
        "text": "=‚ùå *–û—Ç–∫–∞–∑–∞–Ω–æ!*\n\nüë§ {{ $('Process Action').item.json.patientName }}\nüìÖ {{ $('Process Action').item.json.date }} –≤ {{ $('Process Action').item.json.startTime }}\n\n–ó–∞–ø–∏—Å—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç –æ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–∞.",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "telegram-cancel-reply",
      "name": "Reply Cancelled",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1540, 200],
      "credentials": {
        "telegramApi": {
          "id": "",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.simeontsvetanovn8nworkflows.site/webhook/send-sms",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('Process Action').item.json.patientPhone }}\",\n  \"template\": \"booking_rejected\",\n  \"date\": \"{{ $('Process Action').item.json.date }}\",\n  \"time\": \"{{ $('Process Action').item.json.startTime }}\",\n  \"patientName\": \"{{ $('Process Action').item.json.patientName }}\"\n}",
        "options": {}
      },
      "id": "sms-cancelled",
      "name": "SMS Cancelled",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "=‚ö†Ô∏è {{ $json.error }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "telegram-error-reply",
      "name": "Reply Error",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1100, 350],
      "credentials": {
        "telegramApi": {
          "id": "",
          "name": "Telegram API"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Parse Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Callback": {
      "main": [
        [
          {
            "node": "Is Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Valid?": {
      "main": [
        [],
        [
          {
            "node": "Get Calendar Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Calendar Event": {
      "main": [
        [
          {
            "node": "Process Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Action": {
      "main": [
        [
          {
            "node": "Is Confirm?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Cancel?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Confirm?": {
      "main": [
        [
          {
            "node": "Update Event Confirmed",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reply Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Cancel?": {
      "main": [
        [
          {
            "node": "Delete Event Cancelled",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Update Event Confirmed": {
      "main": [
        [
          {
            "node": "Reply Confirmed",
            "type": "main",
            "index": 0
          },
          {
            "node": "SMS Confirmed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Event Cancelled": {
      "main": [
        [
          {
            "node": "Reply Cancelled",
            "type": "main",
            "index": 0
          },
          {
            "node": "SMS Cancelled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "Rodopi Dent"
    }
  ]
}
