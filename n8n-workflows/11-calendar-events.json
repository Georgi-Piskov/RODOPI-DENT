{
  "name": "Rodopi Dent - Calendar Get Events",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "calendar-events",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 0],
      "webhookId": "calendar-events"
    },
    {
      "parameters": {
        "jsCode": "// Parse query parameters\nconst query = $input.first().json.query;\n\n// Default to current week if no dates provided\nconst now = new Date();\nlet startDate, endDate;\n\nif (query.startDate && query.endDate) {\n  startDate = query.startDate;\n  endDate = query.endDate;\n} else if (query.view === 'day') {\n  const date = query.date || now.toISOString().split('T')[0];\n  startDate = date + 'T00:00:00+02:00';\n  endDate = date + 'T23:59:59+02:00';\n} else if (query.view === 'month') {\n  const year = query.year || now.getFullYear();\n  const month = query.month || now.getMonth();\n  const firstDay = new Date(year, month, 1);\n  const lastDay = new Date(year, month + 1, 0);\n  startDate = firstDay.toISOString();\n  endDate = lastDay.toISOString();\n} else {\n  // Default: week view\n  const day = now.getDay();\n  const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Monday\n  const monday = new Date(now.setDate(diff));\n  monday.setHours(0, 0, 0, 0);\n  const sunday = new Date(monday);\n  sunday.setDate(monday.getDate() + 6);\n  sunday.setHours(23, 59, 59, 999);\n  startDate = monday.toISOString();\n  endDate = sunday.toISOString();\n}\n\nreturn [{\n  json: {\n    startDate: startDate,\n    endDate: endDate,\n    view: query.view || 'week'\n  }\n}];"
      },
      "id": "parse-params",
      "name": "Parse Parameters",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 0]
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "rodopi.dent@gmail.com"
        },
        "returnAll": true,
        "options": {
          "timeMax": "={{ $json.endDate }}",
          "timeMin": "={{ $json.startDate }}",
          "singleEvents": true,
          "orderBy": "startTime"
        }
      },
      "id": "google-calendar",
      "name": "Get Calendar Events",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.2,
      "position": [440, 0],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "",
          "name": "Google Calendar"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Transform calendar events to our format\nconst events = $input.all();\n\n// Map Google Calendar colorId (1-11) back to our color names\nconst colorIdToName = {\n  '10': 'green',    // Basil\n  '9': 'blue',      // Blueberry\n  '11': 'red',      // Tomato\n  '5': 'yellow',    // Banana\n  '3': 'purple',    // Grape\n  '6': 'orange',    // Tangerine\n  '4': 'pink',      // Flamingo\n  '8': 'gray'       // Graphite\n};\n\n// Map Bulgarian status labels back to internal values\nconst statusLabelToValue = {\n  'Ñ‡Ð°ÐºÐ°Ñ‰': 'pending',\n  'Ð¿Ð¾Ñ‚Ð²ÑŠÑ€Ð´ÐµÐ½': 'confirmed',\n  'Ð·Ð°Ð²ÑŠÑ€ÑˆÐµÐ½': 'completed'\n};\n\n// Helper function to convert UTC/any timezone to Europe/Sofia\nfunction toSofiaTime(isoString) {\n  if (!isoString) return null;\n  const date = new Date(isoString);\n  // Format in Europe/Sofia timezone\n  const options = {\n    timeZone: 'Europe/Sofia',\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    hour12: false\n  };\n  const formatter = new Intl.DateTimeFormat('en-CA', options);\n  const parts = formatter.formatToParts(date);\n  const getPart = (type) => parts.find(p => p.type === type)?.value || '00';\n  return {\n    date: `${getPart('year')}-${getPart('month')}-${getPart('day')}`,\n    time: `${getPart('hour')}:${getPart('minute')}`\n  };\n}\n\nconst transformed = events.map(item => {\n  const event = item.json;\n  \n  // Parse start/end times\n  const startDateTime = event.start?.dateTime || event.start?.date;\n  const endDateTime = event.end?.dateTime || event.end?.date;\n  \n  let startDate, startTime, endDate, endTime, isAllDay = false;\n  \n  if (event.start?.date) {\n    // All-day event\n    isAllDay = true;\n    startDate = event.start.date;\n    endDate = event.end.date;\n    startTime = '00:00';\n    endTime = '23:59';\n  } else {\n    // Timed event - CONVERT TO SOFIA TIMEZONE\n    const startSofia = toSofiaTime(startDateTime);\n    const endSofia = toSofiaTime(endDateTime);\n    startDate = startSofia.date;\n    startTime = startSofia.time;\n    endDate = endSofia.date;\n    endTime = endSofia.time;\n  }\n  \n  // Calculate duration in minutes\n  const durationMs = new Date(endDateTime) - new Date(startDateTime);\n  const duration = Math.round(durationMs / (1000 * 60));\n  \n  // Parse description for structured data\n  const description = event.description || '';\n  let phone = '';\n  let procedure = '';\n  let appointmentStatus = 'confirmed'; // default\n  \n  // Try to extract phone from description\n  const phoneMatch = description.match(/(?:Ñ‚ÐµÐ»|phone|ðŸ“ž)[:\\s]*([+\\d\\s-]+)/i);\n  if (phoneMatch) phone = phoneMatch[1].trim();\n  \n  // Try to extract procedure\n  const procMatch = description.match(/(?:Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ð°|procedure|ðŸ¦·)[:\\s]*(.+?)(?:\\n|$)/i);\n  if (procMatch) procedure = procMatch[1].trim();\n  \n  // Try to extract status from description\n  const statusMatch = description.match(/(?:ðŸ“‹ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ|ÑÑ‚Ð°Ñ‚ÑƒÑ)[:\\s]*(.+?)(?:\\n|$)/i);\n  if (statusMatch) {\n    const rawStatus = statusMatch[1].trim().toLowerCase();\n    appointmentStatus = statusLabelToValue[rawStatus] || rawStatus;\n  }\n  \n  // Also detect pending from â³ prefix in title\n  const rawTitle = event.summary || '';\n  if (rawTitle.startsWith('â³')) {\n    appointmentStatus = 'pending';\n  }\n  \n  // Clean title - strip â³ prefix for display\n  const cleanTitle = rawTitle.replace(/^â³\\s*/, '');\n  \n  // Map Google colorId to our color name - DEFAULT IS GREEN\n  const colorId = colorIdToName[event.colorId] || 'green';\n  \n  return {\n    json: {\n      id: event.id,\n      googleEventId: event.id,\n      title: cleanTitle || 'Ð‘ÐµÐ· Ð·Ð°Ð³Ð»Ð°Ð²Ð¸Ðµ',\n      patientName: cleanTitle || '',\n      patientPhone: phone,\n      procedure: procedure,\n      description: description,\n      date: startDate,\n      startTime: startTime,\n      endTime: endTime,\n      endDate: endDate,\n      duration: duration,\n      isAllDay: isAllDay,\n      colorId: colorId,\n      status: appointmentStatus,\n      location: event.location || '',\n      htmlLink: event.htmlLink\n    }\n  };\n});\n\nreturn transformed;"
      },
      "id": "transform",
      "name": "Transform Events",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 0]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, events: $input.all().map(i => i.json), count: $input.all().length }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [880, 0]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse Parameters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Parameters": {
      "main": [
        [
          {
            "node": "Get Calendar Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Calendar Events": {
      "main": [
        [
          {
            "node": "Transform Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform Events": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "Rodopi Dent"
    }
  ]
}
